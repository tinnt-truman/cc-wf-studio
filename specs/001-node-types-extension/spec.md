# Feature Specification: ノードタイプ拡張

**Feature Branch**: `001-node-types-extension`
**Created**: 2025-11-01
**Status**: Draft
**Input**: User description: "細かい機能改善をいくつか行いたい。ノード種別にStart,End,Promptを追加など"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ワークフローの開始点を明示的に定義 (Priority: P1)

ユーザーはワークフローの開始点を明確に示すため、Startノードを配置できるようにしたい。これにより、複雑なワークフローでもエントリーポイントが一目で分かるようになる。

**Why this priority**: ワークフローの可読性と保守性を向上させる基本的な機能。新規ユーザーがワークフローの実行フローを理解しやすくなる。

**Independent Test**: Startノードをワークフローエディタに配置し、そのノードが視覚的に開始点として識別できることを確認。Startノードから他のノードへの接続が可能であることを検証。

**Acceptance Scenarios**:

1. **Given** ワークフローエディタが開いている状態, **When** ノードパレットからStartノードを選択してキャンバスに配置, **Then** Startノードが他のノードと視覚的に区別できる形で表示される
2. **Given** Startノードがキャンバス上に配置されている, **When** Startノードから次のノードへ接続線を引く, **Then** 接続が確立され、ワークフローの開始点として機能する
3. **Given** 既存のワークフローを開いた状態, **When** Startノードを追加, **Then** 既存のノード構成に影響を与えずに配置できる

---

### User Story 2 - ワークフローの終了点を明示的に定義 (Priority: P1)

ユーザーはワークフローの終了点を明確に示すため、Endノードを配置できるようにしたい。これにより、複数の終了パターンを持つワークフローでも、各終了条件が明確になる。

**Why this priority**: Startノードと対をなす基本機能。ワークフローの完全性チェックや、実行フローの視覚化に不可欠。

**Independent Test**: Endノードをワークフローに配置し、そのノードがワークフローの終点として機能することを確認。複数のEndノードを配置して、異なる終了パターンを表現できることを検証。

**Acceptance Scenarios**:

1. **Given** ワークフローエディタが開いている状態, **When** ノードパレットからEndノードを選択してキャンバスに配置, **Then** Endノードが終了点として視覚的に識別できる形で表示される
2. **Given** 複数のパスを持つワークフロー, **When** 各パスの終点にEndノードを配置, **Then** すべてのEndノードが独立して終了点として認識される
3. **Given** Endノードに到達した状態, **When** ワークフローを実行, **Then** ワークフローが正常に終了し、Endノードが最終ノードとして記録される

---

### User Story 3 - プロンプト入力用の専用ノードを追加 (Priority: P2)

ユーザーはClaude CodeやAIエージェントに送信するプロンプトを定義するため、Promptノードを使用できるようにしたい。これにより、AI操作を含むワークフローをより直感的に構築できる。

**Why this priority**: AI統合機能の基礎となるが、Start/Endノードなしでも既存ワークフローは動作可能。P1機能の後に実装することで、より完成度の高いAI連携ワークフローを構築できる。

**Independent Test**: Promptノードを配置し、プロンプトテキストを入力・保存できることを確認。Promptノードから後続ノードへデータが渡されることを検証。

**Acceptance Scenarios**:

1. **Given** ワークフローエディタが開いている状態, **When** ノードパレットからPromptノードを選択してキャンバスに配置, **Then** Promptノードが表示され、プロンプト入力欄が利用可能になる
2. **Given** Promptノードが配置されている, **When** プロンプトテキストを入力して保存, **Then** プロンプト内容がノード設定に保存され、次回開いたときも保持されている
3. **Given** Promptノードを含むワークフローを実行, **When** Promptノードに到達, **Then** 設定されたプロンプトが適切な形式で後続処理に渡される
4. **Given** Promptノードにプレースホルダー変数を含むテキスト, **When** ワークフロー実行時に前段のノードから値を受け取る, **Then** プレースホルダーが実際の値に置換されてプロンプトが生成される

---

### Edge Cases

- **複数のStartノードが配置された場合**: 最初に配置されたStartノードを優先、または最も上/左に配置されたノードを開始点とする
- **Endノードがないワークフロー**: 警告を表示するが、実行は可能(最後のノードが暗黙的な終点となる)
- **Startノードがないワークフロー**: 警告を表示するが、実行は可能(最初のノードが暗黙的な開始点となる)
- **Promptノードでプロンプトが空の場合**: ノード設定時に検証エラーを表示
- **Promptノードのプレースホルダーに対応する入力がない場合**: プレースホルダーをそのまま残すか、空文字列に置換
- **既存のワークフローファイルに新しいノードタイプが含まれている場合**: 下位互換性を保ちつつ、新しいノードタイプを読み込める

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはStartノードタイプをサポートし、ワークフローの開始点を明示的に定義できなければならない
- **FR-002**: システムはEndノードタイプをサポートし、ワークフローの終了点を明示的に定義できなければならない
- **FR-003**: システムはPromptノードタイプをサポートし、AIエージェント用のプロンプトテキストを定義できなければならない
- **FR-004**: 新しいノードタイプ(Start, End, Prompt)は既存のノードパレットから選択・配置できなければならない
- **FR-005**: 各ノードタイプは視覚的に区別できるアイコンまたはスタイルを持たなければならない
- **FR-006**: Startノードは出力接続のみを持ち、入力接続は持たない(または警告を表示する)
- **FR-007**: Endノードは入力接続のみを持ち、出力接続は持たない(または警告を表示する)
- **FR-008**: Promptノードはテキスト入力フィールドを持ち、複数行のプロンプトを入力できなければならない
- **FR-009**: Promptノードはプレースホルダー変数(例: `{{variableName}}`)をサポートし、実行時に動的に値を挿入できなければならない
- **FR-010**: 新しいノードタイプはワークフローファイル(JSON形式)に保存・読み込みできなければならない
- **FR-011**: ワークフローエディタは複数のStart/Endノードが配置された場合でも正常に動作しなければならない
- **FR-012**: 既存のワークフローファイルは新しいバージョンでも読み込み可能でなければならない(下位互換性)

### Key Entities

- **Startノード**: ワークフローの開始点を表すノード。ノードタイプID、位置座標、出力接続情報を持つ
- **Endノード**: ワークフローの終了点を表すノード。ノードタイプID、位置座標、入力接続情報を持つ
- **Promptノード**: AIプロンプトを定義するノード。ノードタイプID、位置座標、プロンプトテキスト、プレースホルダー定義、入力/出力接続情報を持つ
- **ノード接続**: ノード間のデータフローを表す。始点ノードID、終点ノードID、接続タイプ(標準/条件分岐など)を持つ

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは3クリック以内でStart, End, Promptノードをワークフローに追加できる
- **SC-002**: 新しいノードタイプを含むワークフローは既存のワークフローと同じ速度で保存・読み込みできる(パフォーマンス劣化なし)
- **SC-003**: 既存の全ワークフローファイルは新バージョンで正常に開ける(100%の下位互換性)
- **SC-004**: ユーザーはPromptノードを使用して、プレースホルダー変数を含む動的なプロンプトを作成できる
- **SC-005**: ワークフローの視覚的な複雑さが軽減され、新規ユーザーが既存ワークフローの構造を理解する時間が平均30%短縮される
- **SC-006**: ノードタイプの追加により、ワークフローエディタの起動時間が500ms以上増加しない

## Assumptions

- ワークフローファイルはJSON形式で保存されている
- ノードパレットはUIコンポーネントとして既に存在している
- プレースホルダー変数の構文は `{{variableName}}` 形式を採用
- 既存のノード接続ロジックは再利用可能
- Start/Endノードの複数配置は許可するが、実行時は最初/最後のノードを優先的に使用
- Promptノードのプロンプトテキストは最大10,000文字まで対応

## Dependencies

- 既存のワークフローエディタUIコンポーネント
- ノードレンダリングシステム
- ワークフローファイルの保存/読み込み機能
- ノード接続の検証ロジック

## Out of Scope

- AIエージェントへの実際のプロンプト送信機能(この仕様ではPromptノードの定義のみ)
- Start/Endノード間の自動パス検証
- ノードタイプのカスタマイズ機能
- ノードのグループ化やサブワークフロー機能
- プロンプトテンプレートライブラリ
