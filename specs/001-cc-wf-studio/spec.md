# Feature Specification: Claude Code Workflow Studio

**Feature Branch**: `001-cc-wf-studio`
**Created**: 2025-11-01
**Status**: Draft
**Input**: User description: "ClaudeCodeのSlashCommands,Sub-Agentを用いたワークフローをユーザー端末にてClaudeCodeのワンショットモードによるコマンド実行で構築できる、VSCode拡張機能を作成したい。ワークフローはVSCode拡張機能で作成した専用画面にてAWS StepFunctionsのUI画面のような形で作成できるようにしたい。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ワークフロービジュアルエディタでの作成 (Priority: P1)

開発者がVSCode上でビジュアルエディタを開き、Claude Codeのワークフローをドラッグ&ドロップで設計できる。ワークフローはSub-Agentをノードとして配置、分岐をAskUserQuestionで配置し、AWS Step Functionsのような視覚的なフローチャート形式で構成する。出来上がったフローはSlashCommandsから実行できる。

**Why this priority**: ワークフローの視覚的な設計機能は本機能の中核であり、これがなければ他の機能も価値を持たない。ユーザーが最初に体験する主要機能として最も重要。

**Independent Test**: VSCode拡張機能をインストール後、コマンドパレットから「Claude Code Workflow Studio」を開き、新規ワークフローを作成。Sub-Agentノードを1つ配置して保存できることを確認すれば、基本的なエディタ機能が動作していると検証できる。

**Acceptance Scenarios**:

1. **Given** VSCodeが起動している状態で、**When** コマンドパレットから「Open Claude Code Workflow Studio」を実行する、**Then** ビジュアルエディタが新しいタブで開く
2. **Given** ビジュアルエディタが開いている状態で、**When** 左側のツールパレットから「Sub-Agent」ノードをキャンバスにドラッグ&ドロップする、**Then** キャンバス上にSub-Agentノードが配置される
3. **Given** ビジュアルエディタが開いている状態で、**When** 左側のツールパレットから「AskUserQuestion」ノードをキャンバスにドラッグ&ドロップする、**Then** キャンバス上にAskUserQuestionノードが配置され、分岐ポートが表示される
4. **Given** キャンバス上にノードが配置されている状態で、**When** ノードをクリックする、**Then** 右側のプロパティパネルにノードの設定項目（名前、プロンプト）が表示される
5. **Given** 2つのノードがキャンバス上にある状態で、**When** ノードの出力ポートから別のノードの入力ポートへドラッグする、**Then** 2つのノードが矢印で接続される
6. **Given** AskUserQuestionノードがキャンバス上にある状態で、**When** 各分岐ポートから異なるノードへ接続する、**Then** 条件分岐を持つワークフローが構成される
7. **Given** ワークフローを編集した状態で、**When** 「保存」ボタンをクリックする、**Then** ワークフロー定義ファイル（JSON/YAML形式）がプロジェクト内の指定ディレクトリに保存される

---

### User Story 2 - ワークフローを.claude設定ファイルで保存 (Priority: P2)

作成したワークフローを、Claude Codeの設定ファイル形式（`.claude`ディレクトリ配下）で保存できる。各Sub-AgentノードはクライアントのSub-Agent設定ファイルとして`.claude/agents/`配下に生成され、ワークフロー全体の流れはSlashCommandsとAskUserQuestionの組み合わせで表現される。これにより、ビジュアルエディタで設計したワークフローが実際のClaude Code環境で実行可能な形式として出力される。

**Why this priority**: ビジュアルエディタで設計したワークフローを実際に使用可能な形で保存できなければ、ツールとしての価値がない。P1のエディタ機能の次に重要な機能として、MVPに含める必要がある。

**Independent Test**: シンプルなワークフロー（Sub-Agentノード1つとAskUserQuestionノード1つ）を作成し、「エクスポート」ボタンをクリック。`.claude/agents/`配下にSub-Agent設定ファイルが生成され、`.claude/commands/`配下にSlashCommand用のマークダウンファイルが生成されることを確認。生成されたファイルの内容が正しいフォーマットであることを検証すれば完了。

**Acceptance Scenarios**:

1. **Given** ワークフローにSub-Agentノードが配置されている状態で、**When** 「エクスポート」ボタンをクリックする、**Then** `.claude/agents/`ディレクトリ配下に各Sub-Agentノードに対応する設定ファイルが生成される
2. **Given** ワークフローにAskUserQuestionノードが含まれている状態で、**When** エクスポートを実行する、**Then** SlashCommandファイル内にAskUserQuestionツールの呼び出しコードが適切に記述される
3. **Given** 複数のノードが接続されたワークフローがある状態で、**When** エクスポートを実行する、**Then** `.claude/commands/`ディレクトリ配下にワークフロー全体を実行するSlashCommandファイルが生成され、ノードの実行順序が正しく反映される
4. **Given** エクスポートが完了した状態で、**When** 生成されたSlashCommandをClaude Codeで実行する、**Then** ビジュアルエディタで設計した通りの順序でSub-Agentが呼び出され、AskUserQuestionによる分岐が機能する

---

### Edge Cases

**MVP版の方針**: 以下のエッジケースは初期バージョンでは**考慮しない**。ユーザーの適切な使用を前提とし、実装範囲を最小化する。

#### 考慮しないエッジケース

1. **ループ（循環参照）の検出**
   - FR-013で警告表示を要件としているが、MVP版では検出ロジックを実装しない
   - ユーザーが循環参照を作成した場合、エクスポート時に不正なSlashCommandが生成される可能性がある
   - 将来のバージョンで対応を検討

2. **大規模ワークフロー（100ノード以上）のパフォーマンス**
   - NFR-001で50ノードまでのサポートを明記
   - 100ノード以上の場合の動作は保証しない

3. **複数ウィンドウでの同時編集**
   - ファイルシステムベースの競合は考慮しない
   - 最後に保存した方が優先される（通常のファイル上書き動作）

4. **手動編集されたワークフロー定義ファイルの不正形式**
   - FR-014でエラーメッセージ表示を要件としているが、MVP版では基本的なJSON/YAMLパースエラーのみ対応
   - 詳細なバリデーション（必須フィールドチェック、データ型検証など）は実装しない

5. **エクスポート時のファイル衝突**
   - DD-005で確認ダイアログ表示を決定済み（対処方針あり）
   - これは考慮するエッジケース

6. **AskUserQuestionノードの未接続分岐ポート**
   - エクスポート時に検証せず、そのままSlashCommandを生成
   - 実行時にClaude Codeが適切に処理することを期待

#### MVP版で対処するエッジケース

- **既存ファイルの上書き確認**（DD-005に基づく）
  - 対処方法: 上書き確認ダイアログを表示
  - ユーザーの選択により、上書き or キャンセルを実行

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはVSCode拡張機能として動作し、VSCode Marketplaceからインストール可能でなければならない
- **FR-002**: システムは専用のビジュアルエディタ画面を提供し、ワークフローをグラフィカルに作成・編集できなければならない
- **FR-003**: ユーザーはSub-Agentノードをワークフローに配置できなければならない
- **FR-004**: ユーザーはAskUserQuestionノードをワークフローに配置し、条件分岐を定義できなければならない
- **FR-005**: ユーザーはノード間の接続（実行順序）をドラッグ&ドロップで定義できなければならない
- **FR-006**: 各ノードのプロパティ（名前、プロンプト）をGUIで編集できなければならない
- **FR-007**: ワークフロー定義は構造化形式（JSONまたはYAML）でファイルとして保存できなければならない
- **FR-008**: 保存されたワークフロー定義ファイルを読み込み、ビジュアルエディタで再編集できなければならない
- **FR-009**: ユーザーはワークフローをClaude Code設定ファイル形式（`.claude`ディレクトリ配下）にエクスポートできなければならない
- **FR-010**: エクスポート時、各Sub-Agentノードは`.claude/agents/`配下にSub-Agent設定ファイルとして生成されなければならない
- **FR-011**: エクスポート時、ワークフロー全体は`.claude/commands/`配下にSlashCommandファイルとして生成されなければならない
- **FR-012**: 生成されたSlashCommandファイルには、AskUserQuestionによる分岐ロジックが適切に記述されなければならない
- **FR-013**: ~~ワークフローに循環参照が含まれる場合、保存時またはエクスポート前に警告を表示しなければならない~~（MVP版では実装しない - Edge Cases参照）
- **FR-014**: ワークフロー定義ファイルの形式エラー（JSON/YAMLパースエラー）を検出し、ユーザーに分かりやすいエラーメッセージを表示しなければならない（MVP版では基本的なパースエラーのみ対応 - Edge Cases参照）
- **FR-015**: システムは日本語と英語のUIをサポートしなければならない

### Non-Functional Requirements

- **NFR-001**: ワークフローエディタは50ノードまで快適に動作しなければならない（SC-002に対応）
- **NFR-002**: ワークフロー定義ファイルの読み込み処理は、ファイルサイズ10KB以下の場合に1秒以内で完了しなければならない（SC-004に対応）
- **NFR-003**: システムはローカル環境での使用を想定し、ユーザー入力値の検証は行わない（MVP版の制約）
- **NFR-004**: エクスポート処理にタイムアウト制限は設けない（MVP版の制約）
- **NFR-005**: システムは将来的なノードタイプ追加を考慮した拡張可能な設計は不要とする（MVP版の制約）
- **NFR-006**: 生成されるファイルはUTF-8エンコーディングでなければならない
- **NFR-007**: UIの操作レスポンスは500ms以内でなければならない（SC-002に対応）

**MVP版の制約事項**:
- セキュリティ: ローカル環境での使用を前提とし、入力検証やサニタイゼーションは実装しない
- パフォーマンス: 大規模ワークフロー（100ノード超）のサポートは保証しない
- 拡張性: 新しいノードタイプ追加のためのプラグインアーキテクチャは実装しない

### Key Entities

- **Workflow（ワークフロー）**: 複数のノードとその接続関係で構成される実行可能な定義。名前、説明、作成日時、最終更新日時、バージョンを持つ。
- **Node（ノード）**: ワークフロー内の1つの処理単位。種類（Sub-Agent、AskUserQuestion）、名前、設定（プロンプト）、入出力ポートを持つ。
- **Connection（接続）**: 2つのノード間の実行順序を表す。開始ノード、終了ノード、条件（オプション）を持つ。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは5分以内に初めてのワークフローを作成し、保存できる
- **SC-002**: ワークフローエディタは50ノードまで滑らかに動作する（操作レスポンス500ms以内）
- **SC-003**: 90%のユーザーがドキュメントやチュートリアルなしで基本的なワークフロー作成ができる
- **SC-004**: ワークフロー定義ファイルのサイズが10KB以下の場合、読み込み時間が1秒以内である
- **SC-005**: エクスポート機能により生成された`.claude`設定ファイルが正しいフォーマットである（YAML frontmatterとMarkdown形式）

## Technical Specifications

### Export Format Details

#### Sub-Agent Configuration File Format

各Sub-Agentノードは以下のフォーマットで`.claude/agents/<node-name>.md`として生成される:

```markdown
---
name: <ノードの名前>
description: <Sub-Agentの目的の説明>
tools: <ツールリスト（カンマ区切り、オプション）>
model: sonnet
---

<Sub-Agentのシステムプロンプト内容>
```

**命名規則**:
- ファイル名: ノード名を小文字化し、スペースをハイフンに置換（例: "Data Analysis" → "data-analysis.md"）
- `name`フィールド: 小文字とハイフンを使用した一意の識別子（ノード名を変換）
- `description`フィールド: Sub-Agentの目的を説明する自然言語テキスト
- `tools`フィールド（オプション）: カンマ区切りのツールリスト。省略時は全ツールにアクセス可能
- `model`フィールド（オプション）: `sonnet`, `opus`, `haiku` のいずれか。デフォルトは `sonnet`

#### SlashCommand Format

ワークフロー全体は以下のフォーマットで`.claude/commands/<workflow-name>.md`として生成される:

```markdown
---
description: <ワークフローの説明>
allowed-tools: Skill,AskUserQuestion
---

<ワークフローの実行ロジック>
```

**実行ロジックの記述方法**:
- Task toolを使用してSub-Agentを順次呼び出し
- AskUserQuestion toolを使用して分岐制御
- 技術的記述ベース（ツール呼び出しを明示的に指示）

**例（2ノード + 1分岐の場合）**:
```markdown
---
description: サンプルワークフロー
allowed-tools: Task,AskUserQuestion
---

まず、Taskツールを使用して「data-analysis」Sub-Agentを実行してください。

次に、AskUserQuestionツールを使用して以下の質問をユーザーに行ってください:
- 質問: "次のステップを選択してください"
- 選択肢:
  - "レポート作成" → Taskツールで「report-generation」Sub-Agentを実行
  - "データ可視化" → Taskツールで「data-visualization」Sub-Agentを実行

ユーザーの選択に応じて、対応するSub-Agentを実行してください。
```

#### AskUserQuestion Node Specification

AskUserQuestionノードは以下の属性を持つ:
- **質問文**: ユーザーに表示する質問テキスト
- **選択肢リスト**: 2個から4個の選択肢（各選択肢にラベルと説明）
- **分岐ポート**: 各選択肢に対応する出力ポート（可変: 2-4個）

**ノードプロパティ**:
- 名前: ノードの識別名
- 質問文: 必須テキストフィールド
- 選択肢1-4: 各選択肢のラベルと説明

### Data Model

#### Workflow Definition (JSON/YAML Format)

内部保存用のワークフロー定義フォーマット:

```json
{
  "name": "ワークフロー名",
  "description": "ワークフローの説明",
  "version": "1.0.0",
  "nodes": [
    {
      "id": "node-1",
      "type": "SubAgent",
      "name": "ノード名",
      "prompt": "プロンプト内容",
      "position": {"x": 100, "y": 100}
    },
    {
      "id": "node-2",
      "type": "AskUserQuestion",
      "name": "分岐ノード",
      "question": "質問文",
      "options": [
        {"label": "選択肢A", "description": "説明A"},
        {"label": "選択肢B", "description": "説明B"}
      ],
      "position": {"x": 300, "y": 100}
    }
  ],
  "connections": [
    {
      "from": "node-1",
      "to": "node-2",
      "fromPort": "output",
      "toPort": "input"
    },
    {
      "from": "node-2",
      "to": "node-3",
      "fromPort": "option-0",
      "toPort": "input",
      "condition": "選択肢A"
    }
  ]
}
```

### File Operations

#### Save Operation
- 対象: ワークフロー定義ファイル（JSON/YAML）
- 保存先: `.vscode/workflows/<workflow-name>.json`
- 目的: ビジュアルエディタでの再編集を可能にする

#### Export Operation
- 対象: `.claude`設定ファイル群（Sub-Agent設定ファイル + SlashCommand）
- 保存先: `.claude/agents/` および `.claude/commands/`
- 衝突処理: 既存ファイルがある場合、上書き確認ダイアログを表示
- 目的: Claude Codeで実行可能な形式として出力

## Design Decisions

このセクションでは、仕様策定時に行った重要な設計判断とその理由を記録します。

### DD-001: ワークフロー定義とエクスポートの分離

**決定**: 「保存」と「エクスポート」を別操作として実装する

**理由**:
- 再編集可能性の維持: JSON/YAML形式でワークフローの完全な構造情報（ノード位置、接続情報）を保持
- Claude Code設定の独立性: `.claude`ディレクトリは実行専用とし、編集用データと分離
- ユーザーの意図の明確化: 編集中の保存と、実行可能形式への変換を明示的に区別

**影響**:
- ユーザーは2段階の操作が必要（保存 → エクスポート）
- 実装が若干複雑になるが、データの整合性が保たれる
- エクスポート後も元のワークフロー定義を編集可能

**代替案**:
- 統合操作（保存時に自動エクスポート）も検討したが、ユーザーが編集途中でも保存したい場合に不要なエクスポートが発生する問題があった

### DD-002: Sub-Agent設定ファイルの公式仕様準拠

**決定**: Sub-Agentノードから生成する設定ファイルはClaude Code公式仕様に準拠（name, description, tools, model, プロンプト）

**理由**:
- Claude Codeの公式Sub-Agent仕様に完全準拠することで互換性を保証
- `tools`フィールドは省略可能で、省略時は全ツールにアクセス可能
- `model`フィールドで実行モデルを指定可能（sonnet/opus/haiku）

**影響**:
- 生成されるSub-Agentは公式仕様通りに動作
- ツール制限が必要な場合はUIで`tools`フィールドを設定可能
- 将来的なClaude Codeアップデートに追従しやすい

**代替案**:
- 独自形式も検討したが、公式仕様準拠が最適と判断

### DD-003: SlashCommandの技術的記述ベース採用

**決定**: SlashCommandファイルは技術的記述ベース（Task tool、AskUserQuestion toolの呼び出しを明示）

**理由**:
- 実行の厳密性と予測可能性を重視
- ワークフロー構造を正確にClaude Codeに伝達
- デバッグ時に生成されたコマンドの動作を理解しやすい

**影響**:
- 生成されるSlashCommandの記述がやや技術的になる
- Claude Codeの内部実装（Task toolの仕様）に依存する
- 自然言語ベースよりも厳格な実行フローが期待できる

**代替案**:
- 自然言語ベースも検討したが、実行の曖昧性が懸念された

### DD-004: AskUserQuestionの可変分岐ポート（2-4個）

**決定**: AskUserQuestionノードの分岐ポート数は2-4個の可変とする

**理由**:
- Claude CodeのAskUserQuestionツールの仕様（2-4個の選択肢）に合わせる
- 柔軟性とシンプルさのバランスを取る
- 実際のユースケースでは2-4個の選択肢で十分

**影響**:
- UIで選択肢数を動的に変更する機能が必要
- 分岐ポートの描画ロジックが可変に対応する必要がある

**代替案**:
- 固定2分岐も検討したが、柔軟性に欠けると判断

### DD-005: ファイル衝突時の確認ダイアログ表示

**決定**: エクスポート時に既存ファイルがある場合、上書き確認ダイアログを表示

**理由**:
- ユーザーが手動で編集した`.claude`設定ファイルを誤って上書きするリスクを回避
- 意図しないデータ損失を防ぐ
- VSCodeの標準的なUXパターンに準拠

**影響**:
- 複数ファイルがある場合、複数回の確認が必要になる可能性
- エクスポート処理が若干遅くなる

**代替案**:
- 自動上書き: スムーズだがリスクが高い
- バックアップ作成: 安全だがファイルが増える

### DD-006: MVP版の制約事項（セキュリティ、拡張性）

**決定**: MVP版では入力検証、拡張性設計を実装しない

**理由**:
- ローカル環境での個人使用を想定し、セキュリティリスクは限定的
- 早期リリースを優先し、実装範囲を最小化
- 実際のユーザーフィードバックを得てから拡張機能を検討

**影響**:
- 悪意ある入力に対する脆弱性が存在（ローカル環境のため許容）
- 将来的な機能追加時にリファクタリングが必要になる可能性
- 初期開発コストとリリース時期を大幅に短縮

**代替案**:
- 完全な入力検証とプラグインアーキテクチャも検討したが、MVP版の目的に反すると判断

## Assumptions

- ユーザーのローカル環境にClaude Codeがインストールされ、認証済みである
- ユーザーはVSCode（バージョン1.80以上）を使用している
- ワークフロー定義ファイルはプロジェクトのルートディレクトリまたは `.vscode/workflows/` ディレクトリに保存される
- Claude Codeのワンショットモード実行はコマンドラインから `claude <prompt>` または `claude -p "<prompt>"` のような形式で実行可能である（実際のCLI仕様に依存）
- 初期バージョンでは、AskUserQuestionによる条件分岐をサポートするが、並列実行はサポートしない（順次実行のみ）
- エクスポートされた`.claude`設定ファイル（Sub-Agent設定ファイルとSlashCommand）は、プロジェクトの`.claude/agents/`および`.claude/commands/`ディレクトリに配置され、Claude Codeによって自動的に認識される
