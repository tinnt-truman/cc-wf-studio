# 機能仕様書: Slack統合型ワークフロー共有

**機能ブランチ**: `001-slack-workflow-sharing`
**作成日**: 2025-11-22
**ステータス**: ドラフト
**入力**: ユーザー説明: "Claude Code Workflow StudioにSlack統合型ワークフロー共有機能を追加する。開発者がVS Code上で作成したワークフロー定義ファイル(JSON)を、チームのSlackチャンネルに直接共有できるようにする。共有されたワークフローは、Slack上でリッチなメッセージカードとして表示され、ワークフロー名、作成者、説明などのメタデータが一目で分かる。他のチームメンバーは、Slackのメッセージからワンクリックで自分のVS Codeにワークフローをインポートできる。手動でのファイルダウンロード、ディレクトリ配置、エディタでの開く操作が不要になる。これにより、プロトタイピング段階でのワークフロー共有が迅速化され、チーム内コラボレーションが促進される。Gitのような重いバージョン管理プロセスを経ずに、アドホックな共有が可能になる。セキュリティ面では、認証情報を安全に管理し、ワークフローに含まれるAPIキーなどの機密情報が誤って共有されないように警告する仕組みを含む。また、VS Code内からSlackに過去に共有されたワークフローを検索し、再利用できる機能も提供する。"

## ユーザーシナリオとテスト

### ユーザーストーリー 1 - VS CodeからSlackへのワークフロー共有 (優先度: P1)

開発者がVS Code上で作成したワークフロー定義ファイルを、チームのSlackチャンネルに直接共有します。共有時には、機密情報の検出と警告が行われ、安全な共有が保証されます。Slack上では、ワークフロー名、作成者、説明などのメタデータを含むリッチメッセージカードとして表示されます。

**この優先度の理由**: ワークフロー共有のコア機能であり、この機能がなければ他の機能が成立しません。チーム内でのワークフロー配布の基盤となる最も重要な機能です。

**独立したテスト**: VS Code上でワークフローを選択し、Slackチャンネルに共有することで完全にテストでき、チームメンバーがSlack上でワークフローの存在を確認できる価値を提供します。

**受け入れシナリオ**:

1. **前提** 開発者がVS Code上でワークフロー定義ファイルを開いている、**実行** 「Slackに共有」コマンドを実行する、**結果** 共有先チャンネル選択ダイアログが表示される
2. **前提** 共有先チャンネルを選択済み、**実行** 共有を実行する、**結果** ワークフローがSlackチャンネルにリッチメッセージカードとして投稿される
3. **前提** ワークフローにAPIキーまたは認証トークンが含まれている、**実行** 共有を実行する、**結果** 機密情報検出の警告ダイアログが表示され、続行または中止を選択できる
4. **前提** 機密情報検出警告で「続行」を選択した、**実行** 共有を完了する、**結果** Slackメッセージに機密情報が含まれる可能性がある旨の注意書きが追加される
5. **前提** Bot User Tokenが未設定、**実行** 「Slackに共有」コマンドを実行する、**結果** トークン入力ダイアログが表示され、Bot User Tokenを入力できる
6. **前提** ワークフロー定義ファイルが不正な形式である、**実行** 共有を実行する、**結果** エラーメッセージが表示され、共有が中止される

---

### ユーザーストーリー 2 - Slackからのワンクリックインポート (優先度: P1)

チームメンバーがSlack上で共有されたワークフローメッセージから、ワンクリックで自分のVS Codeにワークフローをインポートします。手動でのファイルダウンロード、ディレクトリ配置、エディタでの開く操作は不要です。

**この優先度の理由**: ワークフロー共有機能の価値を最大化するために必須です。簡単にインポートできなければ、共有機能の利便性が大きく損なわれます。

**独立したテスト**: Slackメッセージの「VS Codeで開く」ボタンをクリックすることで完全にテストでき、VS Code上でワークフローが自動的に開かれる価値を提供します。

**受け入れシナリオ**:

1. **前提** チームメンバーがSlackでワークフロー共有メッセージを閲覧している、**実行** 「VS Codeで開く」ボタンをクリックする、**結果** VS Codeが起動し、ワークフローが自動的にインポートされて開かれる
2. **前提** 同名のワークフローファイルが既に存在する、**実行** インポートを実行する、**結果** 上書き確認ダイアログが表示され、ユーザーが上書きまたはキャンセルを選択できる
3. **前提** VS Codeが起動していない状態、**実行** 「VS Codeで開く」ボタンをクリックする、**結果** VS Codeが自動的に起動し、ワークフローがインポートされる
4. **前提** ワークフローファイルが破損している、**実行** インポートを実行する、**結果** エラーメッセージが表示され、インポートが失敗する

---

### ユーザーストーリー 3 - VS Code内からの過去ワークフロー検索・再利用 (優先度: P2)

開発者がVS Code内から、Slackに過去に共有されたワークフローを検索し、再利用できます。チャンネル名、ワークフロー名、作成者、共有日時などで絞り込み検索が可能です。

**この優先度の理由**: 共有されたワークフローの再利用性を高め、ナレッジベースとしての価値を提供します。ただし、基本的な共有・インポート機能がなければ意味がないため、P2としています。

**独立したテスト**: VS Code上で「Slackワークフロー検索」コマンドを実行し、過去に共有されたワークフローを検索・インポートすることで完全にテストでき、過去の資産を活用できる価値を提供します。

**受け入れシナリオ**:

1. **前提** 開発者がVS Code上で作業している、**実行** 「Slackワークフロー検索」コマンドを実行する、**結果** 検索ダイアログが表示され、過去に共有されたワークフローの一覧が表示される
2. **前提** ワークフロー一覧が表示されている、**実行** ワークフロー名で検索フィルタを適用する、**結果** 該当するワークフローのみが絞り込まれて表示される
3. **前提** 検索結果からワークフローを選択した、**実行** 「インポート」ボタンをクリックする、**結果** 選択したワークフローがVS Codeにインポートされて開かれる
4. **前提** 検索結果が多数存在する、**実行** 作成者名で絞り込む、**結果** 該当する作成者が共有したワークフローのみが表示される
5. **前提** 検索結果が表示されている、**実行** 共有日時の降順でソートする、**結果** 最新の共有ワークフローが上位に表示される

---

### ユーザーストーリー 4 - Bot User Token管理 (優先度: P3)

開発者が初回利用時にSlack Bot User Tokenを入力し、安全に保存・管理できます。トークンの有効性は自動検証され、無効な場合は再入力が促されます。

**この優先度の理由**: トークン管理は重要ですが、初回設定後は頻繁に操作しないため、P3としています。基本的な共有・インポート機能の実装が優先されます。

**独立したテスト**: 初回利用時にBot User Tokenを入力し、トークンの検証・保存・再設定を行うことで完全にテストでき、安全なトークン管理の価値を提供します。

**受け入れシナリオ**:

1. **前提** 開発者が初めてSlack統合機能を使用する、**実行** 「Slackに共有」コマンドを実行する、**結果** トークン入力ダイアログが表示される
2. **前提** トークン入力ダイアログが表示されている、**実行** Bot User Token (xoxb-で始まる文字列) を入力して保存する、**結果** トークンが検証され、有効な場合は保存完了メッセージが表示される
3. **前提** 無効なBot User Tokenを入力した、**実行** 保存を実行する、**結果** トークン検証エラーが表示され、再入力を促される
4. **前提** Bot User Tokenが既に保存されている、**実行** 「Slack: Manage Token」コマンドを実行する、**結果** 現在のトークン情報(マスク済み)と再設定オプションが表示される
5. **前提** Bot User Tokenが保存されている、**実行** VS Codeを再起動する、**結果** トークン再入力なしで引き続きSlack統合機能が利用できる

---

### エッジケース

- ネットワーク接続が切断された状態で共有またはインポートを実行した場合、どのように処理されるか?
  - エラーメッセージを表示し、ネットワーク接続を確認するよう促す
  - オフライン時には共有・インポート機能を無効化し、グレーアウト表示する

- Slackのレート制限に達した場合、どのように対応するか?
  - レート制限エラーを検出し、ユーザーに待機時間を通知する
  - 自動リトライ機能を実装し、一定時間後に再試行する

- ワークフロー定義ファイルのサイズが極端に大きい(例: 10MB以上)場合、どのように処理するか?
  - 事前にファイルサイズをチェックし、制限を超える場合は警告を表示する
  - Slackのファイル添付制限(通常100MB)を考慮し、適切なサイズ上限を設定する

- Slackチャンネルへのアクセス権限がない場合、どのように処理するか?
  - アクセス可能なチャンネルのみを共有先候補として表示する
  - アクセス権限エラーが発生した場合、明確なエラーメッセージを表示する

- 共有されたワークフローファイルが削除またはアクセス不可になった場合、どのように処理するか?
  - Slackメッセージの添付ファイルとしてワークフローを保存する(別途ストレージは使用しない)
  - メッセージまたは添付ファイルが削除された場合は、エラーメッセージを表示してインポートを中止する
  - 検索結果では、削除されたワークフローを検出し、適切な警告を表示する

- 同じワークフローが複数回共有された場合、どのように識別・管理するか?
  - 共有時刻とメッセージIDを記録し、同一ワークフローの複数バージョンを区別する
  - 検索結果では最新バージョンを優先的に表示する

## 要件

### 機能要件

**共有機能**

- **FR-001**: システムは、開発者がVS Code上でワークフロー定義ファイルを選択し、Slackチャンネルに共有できるようにしなければならない
- **FR-002**: システムは、共有前にワークフロー定義ファイルの妥当性を検証し、不正な形式の場合はエラーメッセージを表示しなければならない
- **FR-003**: システムは、共有時に開発者が共有先のSlackチャンネルを選択できるようにしなければならない
- **FR-004**: システムは、ワークフロー共有時に以下のメタデータを含むリッチメッセージカードをSlackに投稿しなければならない: ワークフロー名、作成者名、説明、共有日時、VS Codeで開くボタン
- **FR-005**: システムは、ワークフロー定義ファイル内にAPIキー、認証トークン、パスワード、秘密鍵などの機密情報が含まれていないかを検出し、含まれている場合は警告を表示しなければならない
- **FR-006**: システムは、機密情報検出警告後も開発者が明示的に共有を続行できるようにしなければならない(警告のみ、強制的なブロックはしない)
- **FR-007**: システムは、機密情報が含まれる可能性があるワークフローを共有した場合、Slackメッセージに注意書きを追加しなければならない

**インポート機能**

- **FR-008**: システムは、Slack上のワークフロー共有メッセージに「VS Codeで開く」ボタンを表示しなければならない
- **FR-009**: システムは、ユーザーが「VS Codeで開く」ボタンをクリックした際、VS Codeを起動してワークフローを自動的にインポートしなければならない
- **FR-010**: システムは、インポートしたワークフローを適切なディレクトリ(`.vscode/workflows/`)に配置しなければならない
- **FR-011**: システムは、インポート後に自動的にワークフローファイルをVS Codeエディタで開かなければならない
- **FR-012**: システムは、インポート時にワークフロー定義ファイルの妥当性を検証し、不正な形式の場合はエラーメッセージを表示しなければならない
- **FR-013**: システムは、インポート時に同名のワークフローファイルが既に存在する場合、上書き確認ダイアログを表示しなければならない
- **FR-014**: システムは、上書き確認ダイアログでユーザーが上書きを選択した場合は既存ファイルを置き換え、キャンセルを選択した場合はインポートを中止しなければならない

**検索・再利用機能**

- **FR-015**: システムは、VS Code内から過去にSlackに共有されたワークフローを検索できる機能を提供しなければならない
- **FR-016**: システムは、ワークフロー検索時に以下の条件で絞り込みができるようにしなければならない: ワークフロー名、作成者名、共有日時範囲、Slackチャンネル名
- **FR-017**: システムは、検索結果を共有日時の降順で表示しなければならない
- **FR-018**: システムは、検索結果からワークフローを選択してインポートできるようにしなければならない

**認証・トークン管理**

- **FR-019**: システムは、初回利用時にBot User Tokenの入力を促し、トークンの有効性を検証しなければならない
- **FR-020**: システムは、ワークフローファイルをSlackメッセージの添付ファイルとして保存しなければならない(外部ストレージへの依存を最小化する)
- **FR-021**: システムは、入力されたBot User TokenをVSCode Secret Storageに安全に保存しなければならない(平文での保存は禁止)
- **FR-022**: システムは、Bot User Tokenが無効化された場合を検出し、トークン再入力が必要な場合はユーザーに通知しなければならない
- **FR-023**: システムは、現在設定されているSlackワークスペース名をVS Code UIに表示しなければならない

### 主要エンティティ

- **ワークフロー定義ファイル**: JSON形式のワークフロー設定ファイル。ノード構成、接続、パラメータなどを含む。ファイルパス、ファイル名、ファイルサイズ、最終更新日時の属性を持つ。
- **ワークフローメタデータ**: ワークフロー名、作成者名、説明、作成日時、共有日時の情報。Slackメッセージカードに表示される。
- **Slackメッセージ**: ワークフロー共有時にSlackチャンネルに投稿されるメッセージ。メッセージID、チャンネルID、投稿日時、リッチカードレイアウト、添付ファイル参照を含む。
- **Slack認証情報**: Bot User Token (xoxb-で始まる文字列)、ワークスペースID、ワークスペース名。VSCode Secret Storageに安全に暗号化して保存される。
- **機密情報パターン**: APIキー、認証トークン、パスワード、秘密鍵などを検出するための正規表現パターン集。検出対象文字列パターン、重要度レベル、説明を含む。

## 成功基準

### 測定可能な成果

- **SC-001**: 開発者がワークフローをVS CodeからSlackに共有するまでの操作時間が30秒以内である
- **SC-002**: チームメンバーがSlackメッセージからワークフローをVS Codeにインポートするまでの操作時間が10秒以内である
- **SC-003**: 機密情報検出機能が、一般的なAPIキーやトークンパターン(AWS、GitHub、Slack、OpenAI等)の90%以上を正確に検出できる
- **SC-004**: ワークフロー共有からインポートまでの一連の操作で、手動ダウンロード・配置・開く操作が完全に不要である
- **SC-005**: VS Code内からの過去ワークフロー検索結果が2秒以内に表示される
- **SC-006**: 過去30日間に共有されたワークフローを100件検索した場合でも、検索結果の表示が3秒以内に完了する
- **SC-007**: Bot User Tokenの入力・検証が30秒以内に完了する
- **SC-008**: 認証情報が暗号化された状態で保存され、平文での保存がゼロ件である
- **SC-009**: 90%のユーザーが最初の試行でワークフローの共有とインポートを正常に完了する
- **SC-010**: ワークフロー共有機能の導入により、チーム内でのワークフロー再利用率が50%以上増加する
